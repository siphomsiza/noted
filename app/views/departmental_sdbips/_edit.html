<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
  <h3><%= "Update #{@departmental_sdbip.kpi}" %></h3>
</div>
<div class="modal-body">
<div class="row">
    <div class="col-lg-10 col-md-offset-1">
<%= form_for @departmental_sdbip, html: {multipart: true} do |f| %>

<div class="row">
  <%= f.fields_for :kpi_results do |kpi_result_for_form| %>

    <%= render 'kpi_result_fields', f: kpi_result_for_form %>

<% end %>
<%= link_to_add_fields "Add Update KPI Fields", f, :kpi_results %>
</div>
<div class="row">
  <div class="panel-group" id="accordion">
              <h5>
                  <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" title="click to view KPI details">Details</a>
              </h5>
          <div id="collapseOne" class="collapse">
                <%= render 'kpi_details' %>
          </div>
          <h5>
              <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" title="click to view KPI results">Results</a>
          </h5>
      <div id="collapseTwo" class="collapse">
        <% if @departmental_sdbip.kpi_results.any? %>
            <%= render 'results' %>
        <% else %>
        <p>No results associated with KPI.</p>
        <% end %>
      </div>
      <h5>
          <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" title="click to view KPI Assurance Review History">Assurance Review History</a>
      </h5>
  <div id="collapseThree" class="collapse">
    <% if @departmental_sdbip.assurances.any? %>
        <%= render 'assurance_review' %>
    <% else %>
    <p>No Assurance Review associated with KPI.</p>
    <% end %>
  </div>
</div>

</div>
    <div class="row">
    <div class="actions col-lg-">
      <%= f.submit "Save", id: "submit_form", class: 'btn col-lg-3 pull-right'%>
    </div>
    </div>
    <% end %>
</div>
</div>
</div>

</div>
</div>
<script>
$(document).ready(function(){
  var selected_value = <%= current_user.id %>;
  $("#update-user").val(selected_value);
  $("#assurance-user").val(selected_value);
  //$("#kpi-result-id").val(selected_kpi);
  var target = <%= @departmental_sdbip.annual_target %>;
  $("#kpi-target").val(target);
  $( "#kpi-actual" ).blur(function() {
  var target_value= parseFloat(target) || 0;
  var actual_value = parseFloat($('#kpi-actual').val()) || 0;
  var percentages=0;
  if(target_value > 0){
    percentages = (actual_value/target_value) * 100;
    if(percentages >= 0 && percentages < 49 ){
      $("#kpi-result").val("KPI Not Met");
    }
    if(percentages >= 50 && percentages < 99 ){
      $("#kpi-result").val("KPI Almost Met");
    }
    if(percentages >= 100 && percentages < 130 ){
      $("#kpi-result").val("KPI Met");
    }
    if(percentages >= 130 && percentages <= 149 ){
      $("#kpi-result").val("KPI Well Met");
    }
    if(percentages >= 150 ){
      $("#kpi-result").val("KPI Extremely Well Met");
    }

  }else {
    $("#kpi-result").val("KPI Not Met");
  }

  });

});

</script>
